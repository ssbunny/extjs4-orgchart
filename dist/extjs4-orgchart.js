Ext.define("Ext.orgchart.Settings",{horizontal:!0,insetPadding:10,horizontalSpace:10,verticalSpace:40,nodeWidth:170,nodeHeight:40,nodeBorderRadius:3,nodeBorderColor:"#EEE",nodeBorderWidth:0,nodeBackgroundColor:"#2073CC",nodeNameColor:"#FFF",nodeNameFontSize:"11px",nodeNameFontWeight:"normal",nodeNameFontFamily:"monospace",nodeValueColor:"#FFE847",nodeValueFontSize:"12px",nodeValueFontWeight:"bold",nodeValueFontFamily:"monospace",nodeInsetPadding:10,connectorLine:"Orthogonal",connectorColor:"#E88B41",connectorWidth:1,connectorMargin:2,expanderType:"square",expanderSize:14,expanderPadding:2,expanderMargin:4,constructor:function(t){Ext.apply(this,t)}},function(){this.defaults=new this}),Ext.define("Ext.orgchart.Node",{isOrgchartNode:!0,nameText:"",valueText:"",color:void 0,expanded:!1,depth:void 0,order:void 0,parent:void 0,children:void 0,container:void 0,x:0,y:0,constructor:function(t){Ext.apply(this,t),this.container||Ext.Error.raise("必须指定 container 属性"),this.initialConfig=t,this.id=t.id||Ext.id(void 0,"orgchart-node-"),this._initSpritesConfig();try{this._darkRectColor=Ext.draw.Color.fromString(this._rectConfig.fill).getDarker(.1).toString()}catch(t){this._darkRectColor=this._rectConfig.fill}return this.container.surface&&this.createSprite(this.container.surface),this},_initSpritesConfig:function(){var t=this.container.settings;this._rectConfig=Ext.apply({},{id:this.id+"-rect",type:"rect",fill:this.color||t.nodeBackgroundColor,width:t.nodeWidth,height:t.nodeHeight,radius:t.nodeBorderRadius,stroke:t.nodeBorderColor,"stroke-width":t.nodeBorderWidth}),this._nameTextConfig=Ext.apply({},{id:this.id+"-text-name",type:"text",text:this.nameText,fill:t.nodeNameColor,"font-weight":t.nodeNameFontWeight,"font-size":t.nodeNameFontSize,"font-family":t.nodeNameFontFamily}),this._valueTextConfig=Ext.apply({},{id:this.id+"-text-value",type:"text",text:this.valueText,fill:t.nodeValueColor,"font-weight":t.nodeValueFontWeight,"font-size":t.nodeValueFontSize,"font-family":t.nodeValueFontFamily})},createSprite:function(t){return this.surface=t,this._rectSprite=Ext.create("Ext.draw.Sprite",this._rectConfig),this._nameTextSprite=Ext.create("Ext.draw.Sprite",this._nameTextConfig),this._valueTextSprite=Ext.create("Ext.draw.Sprite",this._valueTextConfig),this.sprite=Ext.create("Ext.draw.CompositeSprite",{surface:t,id:this.id+"-nodegroup"}),this._bindEvents(),this.sprite.add("rect",this._rectSprite),this.sprite.add("nameText",this._nameTextSprite),this.sprite.add("valueText",this._valueTextSprite),t.add(this._rectSprite),t.add(this._nameTextSprite),t.add(this._valueTextSprite),this.sprite},getSourceAnchor:function(){return{x:this.getSourceAnchorX(),y:this.getSourceAnchorY()}},getSourceAnchorX:function(){var t=this.container.settings;return this.x+t.expanderSize+t.expanderMargin+t.connectorMargin+t.nodeWidth},getSourceAnchorY:function(){var t=this.container.settings;return this.y+.5*t.nodeHeight},getTargetAnchor:function(){return{x:this.getTargetAnchorX(),y:this.getTargetAnchorY()}},getTargetAnchorX:function(){return this.x-this.container.settings.connectorMargin},getTargetAnchorY:function(){var t=this.container.settings;return this.y+.5*t.nodeHeight},preorderTraversal:function(t,e){!function i(n){var r,o;if(t.call(e||n,n),n.children&&n.expanded)for(r=0,o=n.children.length;r<o;++r)i(n.children[r])}(this)},postorderTraversal:function(t,e){!function i(n){var r,o;if(n.children&&n.expanded)for(r=0,o=n.children.length;r<o;++r)i(n.children[r]);t.call(e||n,n)}(this)},_bindEvents:function(){var t=this;this._rectSprite.on("mouseover",this.onNodeMouseOver,this),this._rectSprite.on("mouseout",this.onNodeMouseOut,this),this._rectSprite.on("click",function(){console.log(this)},this),this._nameTextSprite.on("mouseover",function(){t._rectSprite.stopAnimation()}),this._valueTextSprite.on("mouseover",function(){t._rectSprite.stopAnimation()})},isLeaf:function(){return!((this.expanded||!this.children)&&this.children)},destroyIt:function(){this.sprite.hide(!0)},drawIt:function(t){var e,i,n,r=this.container.settings.insetPadding,o=this.container.settings.nodeHeight,a=this.container.settings.nodeWidth,s=Ext.orgchart.OrgChart.NODE_CLASS_PREFIX+this.container.id,d=r+this.x,h=.5*o+this.y;try{e=this._valueTextSprite.getBBox()}catch(t){this._valueTextSprite.hide(!0),e=this._valueTextSprite.getBBox()}i=this.x+(a-e.width-r),n=.5*o+this.y,"move"===t?this._drawItWithAnimiteMove(this.x,this.y,d,h,i,n):this._drawItWithoutAnimite(this.x,this.y,d,h,i,n),this._nameTextSprite.addCls(s),this._valueTextSprite.addCls(s),this._rectSprite.addCls(s)},_drawItWithoutAnimite:function(t,e,i,n,r,o){this._rectSprite.setAttributes({x:t,y:e,hidden:!1},!0),this._nameTextSprite.setAttributes({x:i,y:n,hidden:!1},!0),this._valueTextSprite.setAttributes({x:r,y:o,hidden:!1},!0)},_drawItWithAnimiteMove:function(t,e,i,n,r,o){this._rectSprite.animate({duration:200,to:{x:t,y:e}}),this._nameTextSprite.animate({duration:200,to:{x:i,y:n}}),this._valueTextSprite.animate({duration:200,to:{x:r,y:o}})},iterateLeftSiblings:function(t){var e,i;if(this.parent)for(e=this.order+1,i=this.parent.children.length;e<i;++e)t(this.parent.children[e])},iterateRightSiblings:function(t){var e,i;if(this.parent)for(e=0,i=this.order;e<i;++e)t(this.parent.children[e])},findFirstLeaf:function(){var t;if(this.children&&this.children.length)return t=this.children[0],t.isLeaf()?t:t.findFirstLeaf()},collapseIt:function(){var t=this,e=t.container.settings.nodeHeight,i=t.calculateGiveWay();i&&this.giveWay(.5*(i-e),!0),t.preorderTraversal(function(e){e.id!==t.id&&(e.expander&&e.expander.destroyIt(),e.destroyIt(),e.connector&&e.connector.destroyIt())}),t.expanded=!1,this.updateExpandedLeaves()},expandIt:function(){var t,e=this,i=e.container.settings,n=i.nodeHeight,r=i.nodeWidth,o=i.verticalSpace,a=i.horizontalSpace;this._expandedLeaves=e._expandedLeaves||e.children.length,this.expanded=!0,t=this.calculateGiveWay(),t&&this.giveWay(.5*(t-n)),this.updateExpandedLeaves();var s=0;e.postorderTraversal(function(i){e.id!==i.id&&(i.x=i.depth*(r+o),i.isLeaf()?(i.y=e.y-.5*t+.5*n+s*(n+a),s++):i.y=i.findFirstLeaf().y+.5*i.calculateGiveWay()-.5*n)}),this.preorderTraversal(function(t){e.id!==t.id&&(t.drawExpander(),t.drawIt(),t.drawConnector())})},calculateGiveWay:function(){var t=this.container.settings,e=t.horizontalSpace,i=t.nodeHeight,n=this._expandedLeaves,r=0;return n>1&&(r=n*i+(n-1)*e),r},updateExpandedLeaves:function(){var t=this.parent;t&&(t.markExpandedLeaves(),t.updateExpandedLeaves())},giveWay:function(t,e){var i=e?-1:1;this.isRoot()||(this._moveDistance("iterateLeftSiblings",t*i),this._moveDistance("iterateRightSiblings",-t*i))},_moveDistance:function(t,e){this[t](function(t){t.preorderTraversal(function(t){t.y+=e,t.drawIt("move"),t.expander&&t.expander.drawIt("move"),t.connector&&t.connector.drawIt(!0)})}),this.parent&&!this.parent.isRoot()&&this.parent._moveDistance(t,e)},isRoot:function(){return this.container.findRootNode().id===this.id},drawExpander:function(){var t;this.children&&!this.expander&&(t=Ext.create("Ext.orgchart.Expander",{node:this}),t.drawIt())},drawConnector:function(){var t;this.parent&&!this.connector&&(t=Ext.create("Ext.orgchart.Connector",{node:this}),t.drawIt())},markExpandedLeaves:function(){var t=this;t._expandedLeaves=0,t.preorderTraversal(function(e){t.id!==e.id&&e.isLeaf()&&t._expandedLeaves++})},onNodeMouseOver:function(){this._rectSprite.animate({to:{fill:this._darkRectColor}})},onNodeMouseOut:function(){this._rectSprite.animate({to:{fill:this._rectConfig.fill}})}}),Ext.define("Ext.orgchart.Expander",{isOrgchartExpander:!0,node:void 0,constructor:function(t){return Ext.apply(this,t),this.node||Ext.Error.raise("必须指定 node 属性"),this.node.expander=this,this.initialConfig=t,this.id=t.id||Ext.id([]._,"orgchart-expander-"),this._initSpritesConfig(),this.createSprite(this.node.container.surface),this},_initSpritesConfig:function(){var t=this.node.container.settings,e={};"square"===t.expanderType?(e.type="rect",e.width=t.expanderSize,e.height=t.expanderSize):(e.type="circle",e.radius=.5*t.expanderSize),this._outerConfig=Ext.apply(e,{id:this.id+"-outer",stroke:t.connectorColor,"stroke-width":t.connectorWidth,fill:"#FFF"}),this._innerConfig=Ext.apply({},{id:this.id+"-inner",type:"path",stroke:t.connectorColor,"stroke-width":t.connectorWidth})},_initInnerPath:function(t,e,i,n){var r=["M",t-i+n," ",e,"H",t+i-n];this._minusPath=r.join(""),r=r.concat(["M",t," ",e-i+n,"V",e+i-n]),this._plusPath=r.join("")},drawIt:function(t){var e=this.node.container.settings,i=this.node.expanded?"-":"+",n=.5*e.expanderSize,r=e.expanderPadding,o=this.node.x+e.nodeWidth+n+.5*e.nodeBorderWidth+e.expanderMargin,a=this.node.y+.5*e.nodeHeight,s="rect"===this._outerConfig.type?-n:0;this._initInnerPath(o,a,n,r),"move"===t?this._drawItWithAnimiteMove(i,o,a,s):this._drawItWithoutAnimite(i,o,a,s),this.sprite.get("outer").setStyle("cursor","pointer"),this.sprite.get("inner").setStyle("cursor","pointer")},_drawItWithAnimiteMove:function(t,e,i,n){var r=this;this.sprite.get("outer").animate({duration:200,to:{x:e+n,y:i+n}}),this.sprite.get("inner").animate({duration:200,to:{path:"+"===t?r._plusPath:r._minusPath}})},_drawItWithoutAnimite:function(t,e,i,n){this.sprite.get("outer").setAttributes({x:e+n,y:i+n},!0),this.redrawType(t)},redrawType:function(t){this.sprite.get("inner").setAttributes({path:"+"===t?this._plusPath:this._minusPath},!0)},createSprite:function(t){this.surface=t;var e=Ext.create("Ext.draw.Sprite",this._outerConfig),i=Ext.create("Ext.draw.Sprite",this._innerConfig);return this.sprite=Ext.create("Ext.draw.CompositeSprite",{surface:t,id:this.id+"-expandergroup"}),this.sprite.add("outer",e),this.sprite.add("inner",i),this.sprite.on("click",this.handler,this),t.add(e),t.add(i),this.sprite},destroyIt:function(){this.sprite.get("outer").destroy(),this.sprite.get("inner").destroy(),this.sprite.destroy(),delete this.sprite,delete this.node.expander},handler:function(){var t=this;this.node.children&&(this.isExpanding||(this.isExpanding=!0,setTimeout(function(){t.isExpanding=!1},300),this.node.expanded?(this.node.collapseIt(),this.redrawType("+")):(this.node.expandIt(),this.redrawType("-"))))}}),Ext.define("Ext.orgchart.Connector",{isOrgchartConnector:!0,node:void 0,constructor:function(t){var e;return Ext.apply(this,t),this.node||Ext.Error.raise("必须指定 node 属性"),this.node.connector=this,this.id=t.id||Ext.id([]._,"orgchart-connector-"),e=this.node.container.settings,this._pathConfig=Ext.apply({},{id:this.id+"-path",type:"path",stroke:e.connectorColor,"stroke-width":e.connectorWidth}),this.createSprite(this.node.container.surface),this},createSprite:function(t){return this.surface=t,this.sprite=Ext.create("Ext.draw.Sprite",this._pathConfig),t.add(this.sprite),this.sprite},drawIt:function(t){var e=this.node.parent,i=this.node,n=e.getSourceAnchor(),r=i.getTargetAnchor(),o=.5*(r.x-n.x),a=["M",n.x," ",n.y,"H",n.x+o,"V",r.y,"H",r.x].join("");t?this.sprite.animate({duration:200,to:{path:a}}):this.sprite.setAttributes({path:a},!0)},destroyIt:function(){this.sprite.destroy(),delete this.node.connector}}),Ext.define("Ext.orgchart.OrgChart",{extend:"Ext.draw.Component",requires:["Ext.orgchart.Settings","Ext.orgchart.Node","Ext.orgchart.Connector"],viewBox:!1,settings:Ext.orgchart.Settings.defaults,x:0,y:0,statics:{NODE_CLASS_PREFIX:"orgchart-node-"},onRender:function(){this.callParent(arguments),this.viewBox=!1,this._assertDefine("root"),this._assertDefine("height"),this._assertDefine("width"),this.surface.setViewBox(0,0,this.width,this.height),this._initStyleSheet(),this._initDraggable(),this.nodeManager=this.createNodeManager(),this._initExpandedLeaves(),this.drawIt()},drawIt:function(){this.drawRoot().expandIt(),this.moveToCenter()},drawRoot:function(){var t=this.findRootNode();return t.x=t.y=0,t.drawIt(),t.drawExpander(),t},createNodeManager:function(){var t=this,e=Ext.create("Ext.util.HashMap");return function i(n,r,o,a){var s,d,h=Ext.create("Ext.orgchart.Node",{id:n.id,nameText:n.nameText||"",valueText:n.valueText||"",color:n.color,expanded:!!n.expanded,depth:o,order:a,parent:r,container:t});if(0===o&&0===a&&(e.root=h),r&&(Ext.isArray(r.children)||(r.children=[]),r.children.push(h)),e.add(h),o++,n.children&&Ext.isArray(n.children))for(s=0,d=n.children.length;s<d;++s)i(n.children[s],h,o,s)}(t.root,void 0,0,0),e},findRootNode:function(){return this.nodeManager.root},moveToCenter:function(){var t=this.settings;this.x=-t.insetPadding,this.y=t.nodeHeight-.5*this.height,this.surface.setViewBox(this.x,this.y,this.width,this.height)},_initExpandedLeaves:function(){this.findRootNode().preorderTraversal(function(t){t.markExpandedLeaves()})},_initStyleSheet:function(){var t=Ext.orgchart.OrgChart.NODE_CLASS_PREFIX+this.id,e=[".",t,", .",t," tspan{","cursor:move;","}"].join("");Ext.util.CSS.createStyleSheet(e)},_initDraggable:function(){var t=this,e=this.surface,i=Ext.orgchart.OrgChart.NODE_CLASS_PREFIX+this.id;this.x=e.viewBox.x,this.y=e.viewBox.y,e.on("mousedown",function(n){var r=n.getTarget(null,2),o=!1,a=n.getX(),s=n.getY(),d=function(i){e.setViewBox(a-i.getX()+t.x,s-i.getY()+t.y,t.width,t.height)};o=Ext.supports.ClassList?r.classList.contains(i):r.id&&~r.id.indexOf("-rect"),("tspan"===r.tagName||o&&"rect"===r.tagName)&&(e.on("mousemove",d,t),e.on("mouseup",function(){e.un("mousemove",d,t),t.x=t.surface.viewBox.x,t.y=t.surface.viewBox.y},t,{single:!0}))})},_assertDefine:function(t){void 0===this[t]&&Ext.Error.raise("必须为 Ext.orgchart.OrgChart 实例指定 "+t+" 属性")}});